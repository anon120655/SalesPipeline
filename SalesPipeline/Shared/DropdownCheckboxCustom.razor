
<div id="dropdown_elm" class="dropdown" @onblur="CloseDropdown" tabindex="0">
	<button type="button" @onclick="ToggleDropdown" class="btn btn-outline-secondary dropdown-toggle d-flex flex-wrap">
		@if (SelectedItems.Any())
		{
			@foreach (var selectedItem in SelectedItems)
			{
				<span class="selected-item">
					@selectedItem.Name
					<button type="button" @onclick="(e) => RemoveItem(selectedItem.ID, e)" class="btn btn-sm btn-danger remove-btn">x</button>
				</span>
			}
		}
		else
		{
			<span>เลือก</span>
		}
	</button>
	<div class="dropdown-menu @(isDropdownOpen ? "show" : "")" tabindex="-1">
		<input type="text" @bind="searchTerm" placeholder="Search..." class="form-control search-input" @oninput="OnSearchInput" />
		@foreach (var item in filteredItems)
		{
			@* <div class="dropdown-item">
				<input type="checkbox" id="@item.ID" @bind="item.IsSelected" @bind:event="onchange" />
				<label for="@item.ID">@item.Name</label>
			</div> *@
			<label class="dropdown-item">
				<input type="checkbox" id="@item.ID" @bind="item.IsSelected" @bind:event="onchange" />
				@item.Name
			</label>
		}
	</div>
</div>

@code {
	private bool isDropdownOpen = false;
	private string searchTerm = string.Empty;

	[Parameter]
	public int type { get; set; }

	[Parameter]
	public List<SelectModel> items { get; set; } = null!;

	[Parameter]
	public EventCallback<DropdownCheckboxMain> callbackItemsSelected { get; set; }

	private List<SelectModel> filteredItems = new();

	protected override void OnInitialized()
	{
		filteredItems = items;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await _jsRuntimes.InvokeVoidAsync("addBlurHandler", "dropdown_elm", DotNetObjectReference.Create(this));
		}
	}

	[JSInvokable]
	public void CloseDropdown()
	{
		isDropdownOpen = false;
		StateHasChanged();
	}

	private IEnumerable<SelectModel> SelectedItems => items.Where(item => item.IsSelected);

	private async Task ToggleDropdown()
	{
		isDropdownOpen = !isDropdownOpen;

		if (!isDropdownOpen)
		{
			await callbackItemsSelected.InvokeAsync(new()
				{
					Type = type,
					SelectedItems = SelectedItems.ToList()
				});
		}
	}

	private void OnSearchInput(ChangeEventArgs e)
	{
		if (e.Value != null)
		{
			searchTerm = e.Value.ToString() ?? string.Empty;
		}
		FilterItems();
	}

	private void FilterItems()
	{
		filteredItems = items.Where(item => item.Name != null && item.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
	}

	private void RemoveItem(string? itemId, MouseEventArgs e)
	{
		// e.StopPropagation(); // Prevent the dropdown from closing when clicking the remove button
		var item = items.FirstOrDefault(i => i.ID == itemId);
		if (item != null)
		{
			item.IsSelected = false;
			FilterItems();
		}
	}

}